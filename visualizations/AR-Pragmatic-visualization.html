<!DOCTYPE html>
<html>
  <head>
    <title>AR Pragmatic Visualization</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated libraries with specific versions known to work well together -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    <style>
      body { 
        margin: 0; 
        overflow: hidden; 
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      
      .arjs-loader {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .arjs-loader div {
        text-align: center;
        font-size: 1.25em;
        color: white;
      }
      
      #p5-overlay {
        position: fixed;
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%;
        pointer-events: auto; /* Changed to allow interaction */
        z-index: 10;
        display: none;
      }
      
      #ar-info {
        position: fixed;
        left: 10px; 
        bottom: 10px;
        background: rgba(255,255,255,0.9);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 12px;
        font-family: 'Courier New', monospace;
        color: #445878;
        z-index: 20;
      }
      
      #start-button {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
        padding: 15px 25px;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="arjs-loader">
      <div>Loading AR experience... please wait</div>
    </div>
    
    <button id="start-button">Start AR Experience</button>
    
    <!-- AR Scene will be inserted here dynamically -->
    <div id="ar-scene-container"></div>
    
    <div id="p5-overlay"></div>
    
    <div id="ar-info">
      <b>Pragmatic Visualization (AR)</b><br>
      Point at the Hiro marker to see the visualization.<br>
      <b>Interact:</b> Tap/click and drag on the overlay!
    </div>
    
    <script>
      // Global variables
      let p5Instance = null;
      let arStarted = false;
      const startButton = document.getElementById('start-button');
      const arSceneContainer = document.getElementById('ar-scene-container');
      const p5Overlay = document.getElementById('p5-overlay');
      const loader = document.querySelector('.arjs-loader');
      
      // Log to console for debugging
      function log(message) {
        console.log('[AR Debug]', message);
      }
      
      // Function to initialize AR.js and A-Frame scene
      function initializeAR() {
        log('Initializing AR scene');
        
        // Create and insert the AR scene
        const sceneHTML = `
          <a-scene 
            embedded
            arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false;"
            renderer="logarithmicDepthBuffer: true; precision: mediump;"
            vr-mode-ui="enabled: false"
            gesture-detector
            device-orientation-permission-ui="enabled: false">
            
            <!-- Using default hiro marker from AR.js library -->
            <a-marker preset="hiro" id="hiro-marker" raycaster="objects: .clickable" emitevents="true">
              <!-- Invisible entity to confirm marker is loaded -->
              <a-entity scale="0.001 0.001 0.001"></a-entity>
            </a-marker>
            
            <!-- Camera with default settings -->
            <a-entity camera></a-entity>
          </a-scene>
        `;
        
        // Insert AR scene into the container
        arSceneContainer.innerHTML = sceneHTML;
        
        // Hide loader after scene is created
        loader.classList.add('hidden');
        
        // Set up marker detection events
        setTimeout(() => {
          const marker = document.getElementById('hiro-marker');
          if (marker) {
            log('Marker element found, setting up events');
            
            marker.addEventListener('markerFound', () => {
              log('Marker found!');
              p5Overlay.style.display = 'block';
            });
            
            marker.addEventListener('markerLost', () => {
              log('Marker lost');
              p5Overlay.style.display = 'none';
            });
          } else {
            log('ERROR: Marker element not found!');
          }
        }, 1000);
      }
      
      // Function to start the AR experience
      function startAR() {
        if (arStarted) return;
        arStarted = true;
        
        log('Starting AR experience');
        startButton.classList.add('hidden');
        
        // Request camera permission
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: window.innerWidth },
              height: { ideal: window.innerHeight }
            } 
          })
          .then(function(stream) {
            log('Camera permission granted');
            
            // Stop the test stream
            stream.getTracks().forEach(track => track.stop());
            
            // Initialize AR scene
            initializeAR();
            
            // Initialize p5.js sketch
            initP5Overlay();
          })
          .catch(function(err) {
            log('Camera access error: ' + err);
            alert('Camera access is required for AR. Please allow camera access and try again.');
            arStarted = false;
            startButton.classList.remove('hidden');
            loader.classList.add('hidden');
          });
        } else {
          log('getUserMedia not supported');
          alert('Your browser does not support camera access required for AR.');
          arStarted = false;
          startButton.classList.remove('hidden');
          loader.classList.add('hidden');
        }
      }
      
      // Function to initialize p5.js overlay
      function initP5Overlay() {
        log('Initializing p5.js overlay');
        
        // If p5 instance already exists, remove it
        if (p5Instance) {
          p5Instance.remove();
          p5Instance = null;
        }
        
        // Load the external sketch file
        try {
          const script = document.createElement('script');
          script.src = 'pragmatic-sketch.js';
          script.onload = function() {
            log('pragmatic-sketch.js loaded successfully');
            // The sketch should initialize itself
          };
          script.onerror = function() {
            log('Could not load pragmatic-sketch.js, using fallback');
            
            // Create a basic fallback sketch
            const fallbackSketch = function(p) {
              p.setup = function() {
                const canvas = p.createCanvas(p.windowWidth, p.windowHeight);
                canvas.parent('p5-overlay');
                p.background(0, 0);
              };
              
              p.draw = function() {
                p.clear();
                p.noFill();
                p.stroke(255, 0, 0);
                p.strokeWeight(3);
                p.circle(p.width/2, p.height/2, 200);
                p.textSize(24);
                p.fill(255);
                p.textAlign(p.CENTER, p.CENTER);
                p.text("Marker Detected!", p.width/2, p.height/2);
              };
              
              p.windowResized = function() {
                p.resizeCanvas(p.windowWidth, p.windowHeight);
              };
            };
            
            p5Instance = new p5(fallbackSketch);
          };
          document.body.appendChild(script);
        } catch (e) {
          log('Error loading script: ' + e);
        }
      }
      
      // Add start button click handler
      startButton.addEventListener('click', startAR);
      
      // Handle window resize
      window.addEventListener('resize', function() {
        if (p5Instance && p5Instance.windowResized) {
          p5Instance.windowResized();
        }
      });
      
      // Handle device rotation
      window.addEventListener('orientationchange', function() {
        setTimeout(function() {
          if (p5Instance && p5Instance.windowResized) {
            p5Instance.windowResized();
          }
        }, 200);
      });
    </script>
  </body>
</html>
