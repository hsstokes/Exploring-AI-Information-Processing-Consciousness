<!DOCTYPE html>
<html>
  <head>
    <title>AR Pragmatic Visualization</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; ">
    <!-- Updated libraries with specific versions known to work well together -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    <style>
      body { 
        margin: 0; 
        overflow: hidden; 
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        color: #fff;
        font-family: 'Courier New', monospace;
      }
      
      .arjs-loader {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .arjs-loader div {
        text-align: center;
        font-size: 1.25em;
        color: white;
        max-width: 80%;
        padding: 20px;
        border-radius: 10px;
        background-color: rgba(40, 40, 40, 0.7);
      }
      
      #p5-overlay {
        position: fixed;
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%;
        pointer-events: auto; /* Changed to allow interaction */
        z-index: 10;
        display: none;
      }
      
      #ar-info {
        position: fixed;
        left: 10px; 
        bottom: 10px;
        background: rgba(255,255,255,0.9);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 12px;
        font-family: 'Courier New', monospace;
        color: #445878;
        z-index: 20;
        max-width: calc(100% - 20px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }
      
      #start-button {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
        padding: 15px 25px;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: background-color 0.3s, transform 0.2s;
      }
      
      #start-button:hover {
        background: #3b78e7;
        transform: translate(-50%, -50%) scale(1.05);
      }
      
      #start-button:active {
        transform: translate(-50%, -50%) scale(0.98);
      }
      
      #camera-fallback {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #1a1a1a;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        z-index: 9998;
        padding: 20px;
      }
      
      #camera-fallback h2 {
        color: #fff;
        margin-bottom: 20px;
      }
      
      #camera-fallback p {
        color: #ddd;
        margin-bottom: 30px;
        max-width: 600px;
      }
      
      #retry-button {
        padding: 12px 24px;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
      }
      
      .status-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 100;
        display: none;
      }
      
      .hidden {
        display: none !important;
      }
      
      /* Animation for the loader */
      @keyframes pulse {
        0% { opacity: 0.4; }
        50% { opacity: 1; }
        100% { opacity: 0.4; }
      }
      
      .loading-dots {
        animation: pulse 1.5s infinite;
        display: inline-block;
      }
      
      #fallback-button {
        position: fixed;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
        padding: 12px 20px;
        background: #f39c12;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        display: none;
      }
      
      #debug-panel {
        position: fixed;
        bottom: 60px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: #2ecc71;
        font-family: monospace;
        font-size: 10px;
        padding: 5px;
        border-radius: 5px;
        max-width: 80%;
        max-height: 100px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }
      
      #ios-prompt {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 10000;
        max-width: 80%;
        text-align: center;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="arjs-loader">
      <div>
        Loading AR experience<span class="loading-dots">...</span><br>
        <small>Please wait while resources are initialized</small>
      </div>
    </div>
    
    <button id="start-button">Start AR Experience</button>
    <button id="fallback-button">Continue Without AR</button>
    
    <div id="camera-fallback">
      <h2>Camera Access Required</h2>
      <p>To use this AR visualization, camera access is required. Please allow camera access in your browser settings and try again.</p>
      <button id="retry-button">Try Again</button>
    </div>
    
    <!-- AR Scene will be inserted here dynamically -->
    <div id="ar-scene-container"></div>
    
    <div id="p5-overlay"></div>
    
    <div id="ar-info">
      <b>Pragmatic Visualization (AR)</b><br>
      Point at the Hiro marker to see the visualization.<br>
      <b>Interact:</b> Tap/click and drag on the overlay!
    </div>
    
    <div class="status-indicator" id="status-indicator">Searching for marker</div>
    <div id="debug-panel"></div>
    <div id="ios-prompt">Tap anywhere to enable camera<br>(iOS may require additional permissions)</div>
    
    <script>
      // Global variables
      let p5Instance = null;
      let arStarted = false;
      let markerFound = false;
      let debugMode = false; // Set to true to show additional debugging
      const startButton = document.getElementById('start-button');
      const fallbackButton = document.getElementById('fallback-button');
      const retryButton = document.getElementById('retry-button');
      const arSceneContainer = document.getElementById('ar-scene-container');
      const p5Overlay = document.getElementById('p5-overlay');
      const loader = document.querySelector('.arjs-loader');
      const cameraFallback = document.getElementById('camera-fallback');
      const statusIndicator = document.getElementById('status-indicator');
      const debugPanel = document.getElementById('debug-panel');
      const iosPrompt = document.getElementById('ios-prompt');
      
      // Determine if this is iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      
      // Add global error handler
      window.onerror = function(message, source, lineno, colno, error) {
        log('ERROR: ' + message, true);
        document.querySelector('.arjs-loader div').innerHTML = 
          'Error detected: ' + message + '<br><button id="reload-btn" style="margin-top:10px; padding:8px 16px;">Try Again</button>' +
          '<button id="bypass-btn" style="margin-top:10px; margin-left:10px; padding:8px 16px;">Skip AR</button>';
        
        setTimeout(function() {
          const reloadBtn = document.getElementById('reload-btn');
          const bypassBtn = document.getElementById('bypass-btn');
          
          if (reloadBtn) {
            reloadBtn.addEventListener('click', function() {
              location.reload();
            });
          }
          
          if (bypassBtn) {
            bypassBtn.addEventListener('click', function() {
              skipToVisualization();
            });
          }
        }, 100);
        
        return true;
      };
      
      // Log to console and optionally to debug panel
      function log(message, isError = false) {
        console.log('[AR Debug]', message);
        
        if (debugMode) {
          debugPanel.style.display = 'block';
          const entry = document.createElement('div');
          entry.textContent = '> ' + message;
          if (isError) entry.style.color = '#e74c3c';
          debugPanel.appendChild(entry);
          debugPanel.scrollTop = debugPanel.scrollHeight;
        }
      }
      
      // Skip AR and go directly to visualization
      function skipToVisualization() {
        log('Skipping AR, loading visualization directly');
        document.querySelector('.arjs-loader').classList.add('hidden');
        startButton.classList.add('hidden');
        fallbackButton.classList.add('hidden');
        
        // Create a background container
        const container = document.createElement('div');
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '0';
        container.style.width = '100%';
        container.style.height = '100%';
        container.style.backgroundColor = '#1a1a1a';
        container.style.zIndex = '5';
        document.body.appendChild(container);
        
        // Show the p5 overlay
        p5Overlay.style.display = 'block';
        
        // Load the p5 sketch directly
        initP5Overlay();
      }
      
      // Function to initialize AR.js and A-Frame scene
      function initializeAR() {
        log('Initializing AR scene');
        
        // Create and insert the AR scene
        const sceneHTML = `
          <a-scene 
            embedded
            arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false;"
            renderer="logarithmicDepthBuffer: true; precision: mediump; antialias: true;"
            vr-mode-ui="enabled: false"
            gesture-detector
            device-orientation-permission-ui="enabled: false">
            
            <!-- Using default hiro marker from AR.js library -->
            <a-marker preset="hiro" id="hiro-marker" raycaster="objects: .clickable" emitevents="true">
              <!-- Invisible entity to confirm marker is loaded -->
              <a-entity scale="0.001 0.001 0.001"></a-entity>
            </a-marker>
            
            <!-- Camera with default settings -->
            <a-entity camera></a-entity>
          </a-scene>
        `;
        
        // Insert AR scene into the container
        arSceneContainer.innerHTML = sceneHTML;
        
        // Hide loader after scene is created
        loader.classList.add('hidden');
        
        // Show status indicator
        statusIndicator.style.display = 'block';
        statusIndicator.textContent = 'Searching for marker';
        
        // Set up marker detection events
        setTimeout(() => {
          const marker = document.getElementById('hiro-marker');
          if (marker) {
            log('Marker element found, setting up events');
            
            marker.addEventListener('markerFound', () => {
              log('Marker found!');
              markerFound = true;
              p5Overlay.style.display = 'block';
              statusIndicator.textContent = 'Marker detected';
              statusIndicator.style.backgroundColor = 'rgba(40, 167, 69, 0.7)';
              
              // Hide status indicator after 3 seconds
              setTimeout(() => {
                statusIndicator.style.display = 'none';
              }, 3000);
            });
            
            marker.addEventListener('markerLost', () => {
              log('Marker lost');
              markerFound = false;
              p5Overlay.style.display = 'none';
              statusIndicator.style.display = 'block';
              statusIndicator.textContent = 'Marker lost - searching again';
              statusIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            });
          } else {
            log('ERROR: Marker element not found!', true);
            statusIndicator.textContent = 'Error: Marker not found';
            statusIndicator.style.backgroundColor = 'rgba(220, 53, 69, 0.7)';
            
            // Show fallback button after a short delay
            setTimeout(() => {
              fallbackButton.style.display = 'block';
            }, 2000);
          }
        }, 1000);
      }
      
      // Function to start the AR experience
      function startAR() {
        if (arStarted) return;
        arStarted = true;
        
        log('Starting AR experience');
        startButton.classList.add('hidden');
        loader.classList.remove('hidden');
        
        // For iOS, show special prompt
        if (isIOS) {
          setTimeout(() => {
            iosPrompt.style.display = 'block';
            setTimeout(() => {
              iosPrompt.style.display = 'none';
            }, 5000);
          }, 1000);
        }
        
        // Show fallback button after a delay
        setTimeout(() => {
          fallbackButton.style.display = 'block';
        }, 8000);
        
        // Request camera permission
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: window.innerWidth },
              height: { ideal: window.innerHeight }
            } 
          })
          .then(function(stream) {
            log('Camera permission granted');
            
            // Stop the test stream
            stream.getTracks().forEach(track => track.stop());
            
            // Initialize AR scene
            initializeAR();
            
            // Initialize p5.js sketch
            initP5Overlay();
          })
          .catch(function(err) {
            log('Camera access error: ' + err, true);
            cameraFallback.style.display = 'flex';
            loader.classList.add('hidden');
            arStarted = false;
            
            // Show fallback option
            fallbackButton.style.display = 'block';
          });
        } else {
          log('getUserMedia not supported', true);
          alert('Your browser does not support camera access required for AR.');
          arStarted = false;
          startButton.classList.remove('hidden');
          loader.classList.add('hidden');
          
          // Show fallback option
          fallbackButton.style.display = 'block';
        }
      }
      
      // Function to initialize p5.js overlay
      function initP5Overlay() {
        log('Initializing p5.js overlay');
        
        // If p5 instance already exists, remove it
        if (p5Instance) {
          p5Instance.remove();
          p5Instance = null;
        }
        
        // Load the external sketch file
        try {
          const script = document.createElement('script');
          script.src = 'pragmatic-sketch.js';
          script.onload = function() {
            log('pragmatic-sketch.js loaded successfully');
            // The sketch should initialize itself
          };
          script.onerror = function(e) {
            log('Could not load pragmatic-sketch.js: ' + e, true);
            log('Using fallback visualization');
            
            // Create a basic fallback sketch
            const fallbackSketch = function(p) {
              p.setup = function() {
                const canvas = p.createCanvas(p.windowWidth, p.windowHeight);
                canvas.parent('p5-overlay');
                p.background(0, 0);
              };
              
              p.draw = function() {
                p.clear();
                
                // Draw a hexagonal grid as fallback
                p.push();
                p.translate(p.width/2, p.height/2);
                
                // Draw central node
                p.noStroke();
                p.fill(68, 88, 120, 200);
                p.ellipse(0, 0, 60, 60);
                p.fill(255, 255, 255, 100);
                p.ellipse(0, 0, 40, 40);
                
                // Draw hexagons
                const time = p.millis() * 0.001;
                const hexSize = 30;
                
                for (let i = 0; i < 8; i++) {
                  const angle = i * (p.TWO_PI / 8);
                  const radius = 150 + Math.sin(time + i * 0.5) * 20;
                  const x = Math.cos(angle) * radius;
                  const y = Math.sin(angle) * radius;
                  
                  p.push();
                  p.translate(x, y);
                  p.rotate(time * 0.2 + i * 0.2);
                  
                  p.fill(68, 88, 120, 150);
                  p.beginShape();
                  for (let j = 0; j < 6; j++) {
                    const hAngle = j * (p.TWO_PI / 6);
                    const hx = Math.cos(hAngle) * hexSize;
                    const hy = Math.sin(hAngle) * hexSize;
                    p.vertex(hx, hy);
                  }
                  p.endShape(p.CLOSE);
                  
                  // Draw connecting line
                  p.stroke(40, 180, 170, 100);
                  p.strokeWeight(1.5);
                  p.line(0, 0, -x, -y);
                  
                  p.pop();
                }
                
                p.pop();
                
                // Draw text
                p.textSize(24);
                p.fill(255);
                p.textAlign(p.CENTER, p.CENTER);
                p.text("Marker Detected!", p.width/2, p.height/2 - 120);
                p.textSize(16);
                p.text("(Fallback Visualization)", p.width/2, p.height/2 - 90);
              };
              
              p.windowResized = function() {
                p.resizeCanvas(p.windowWidth, p.windowHeight);
              };
              
              // Add mouse interaction
              p.mousePressed = function() {
                // Simple interaction for fallback
              };
              
              p.mouseDragged = function() {
                // Simple interaction for fallback
              };
            };
            
            p5Instance = new p5(fallbackSketch);
          };
          document.body.appendChild(script);
        } catch (e) {
          log('Error creating script element: ' + e, true);
          statusIndicator.textContent = 'Error loading visualization';
          statusIndicator.style.backgroundColor = 'rgba(220, 53, 69, 0.7)';
        }
      }
      
      // Add start button click handler
      startButton.addEventListener('click', startAR);
      
      // Add fallback button click handler
      fallbackButton.addEventListener('click', skipToVisualization);
      
      // Add retry button click handler
      retryButton.addEventListener('click', function() {
        cameraFallback.style.display = 'none';
        startButton.classList.remove('hidden');
      });
      
      // Handle window resize
      window.addEventListener('resize', function() {
        if (p5Instance && p5Instance.windowResized) {
          p5Instance.windowResized();
        }
      });
      
      // Handle device rotation
      window.addEventListener('orientationchange', function() {
        setTimeout(function() {
          if (p5Instance && p5Instance.windowResized) {
            p5Instance.windowResized();
          }
        }, 200);
      });
      
      // For iOS, handle document clicks to help with camera initialization
      if (isIOS) {
        document.addEventListener('click', function() {
          log('Document clicked, helping iOS camera init');
          
          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && !arStarted) {
            navigator.mediaDevices.getUserMedia({ video: true })
              .then(function(stream) {
                log('iOS camera test successful');
                stream.getTracks().forEach(track => track.stop());
              })
              .catch(function(err) {
                log('iOS camera test failed: ' + err, true);
              });
          }
        }, { once: true });
      }
      
      // Add event for when page loses visibility (user switches apps)
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible' && arStarted) {
          log('Page became visible again, checking AR status');
          
          // If AR was started but marker isn't being detected, try to reinitialize
          if (!markerFound && arStarted) {
            log('AR seems stalled, showing fallback option');
            fallbackButton.style.display = 'block';
          }
        }
      });
      
      // Add better error handling for AR.js initialization
      window.addEventListener('artoolkit-loaded', function() {
        log('AR.js toolkit loaded successfully');
      });
      
      window.addEventListener('camera-error', function() {
        log('Camera error occurred in AR.js', true);
        cameraFallback.style.display = 'flex';
        loader.classList.add('hidden');
        fallbackButton.style.display = 'block';
      });
      
      // Timeout handling - if loading takes too long
      setTimeout(function() {
        if (loader && !loader.classList.contains('hidden')) {
          log('Loading timeout - AR initialization taking too long', true);
          document.querySelector('.arjs-loader div').innerHTML = 
            'Loading taking longer than expected.<br><br>Issues detected:<ul style="text-align:left;margin:10px 30px;">' +
            '<li>Camera may not be initializing correctly</li>' +
            '<li>Device may not fully support WebAR</li>' +
            '<li>Browser may be blocking camera access</li></ul>' +
            '<button id="manual-start" style="margin-top:15px; padding:10px 20px; background:#3498db; border:none; border-radius:5px; color:white;">Force Start AR</button>' +
            '<button id="skip-ar" style="margin-top:15px; margin-left:10px; padding:10px 20px; background:#e74c3c; border:none; border-radius:5px; color:white;">Skip AR</button>';
          
          document.getElementById('manual-start').addEventListener('click', function() {
            loader.classList.add('hidden');
            // Attempt to continue anyway
            initializeAR();
          });
          
          document.getElementById('skip-ar').addEventListener('click', function() {
            skipToVisualization();
          });
        }
      }, 15000); // 15 second timeout
      
      // Device capability detection
      const deviceInfo = {
        isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
        isIOS: isIOS,
        isAndroid: /Android/i.test(navigator.userAgent),
        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent)
      };
      
      log('Device info: ' + JSON.stringify(deviceInfo));
      
      // Debug mode toggle - double tap in bottom right corner
      let tapCount = 0;
      let tapTimer = null;
      
      document.addEventListener('click', function(e) {
        // Check if click is in bottom right corner
        if (e.clientX > window.innerWidth * 0.8 && e.clientY > window.innerHeight * 0.8) {
          tapCount++;
          
          if (tapCount === 1) {
            tapTimer = setTimeout(function() {
              tapCount = 0;
            }, 500);
          } else if (tapCount === 2) {
            clearTimeout(tapTimer);
            tapCount = 0;
            
            // Toggle debug mode
            debugMode = !debugMode;
            debugPanel.style.display = debugMode ? 'block' : 'none';
            log('Debug mode: ' + (debugMode ? 'ON' : 'OFF'));
          }
        }
      });
    </script>
  </body>
</html>
