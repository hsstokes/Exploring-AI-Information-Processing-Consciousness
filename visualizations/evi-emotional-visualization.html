<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evi's Emotional Pattern Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: row;
            overflow: hidden;
            background-color: rgb(240, 245, 250);
            font-family: 'Roboto Mono', monospace;
            -webkit-text-size-adjust: 100%;
            touch-action: none;
        }
        
        /* Back button - FIXED: highest z-index, always clickable */
        .back-button {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 100000;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255, 182, 193, 0.95);
            border: none;
            border-radius: 25px;
            text-decoration: none;
            color: white;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            touch-action: manipulation;
            user-select: none;
        }

        .back-button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
            pointer-events: none;
        }
        
        .back-button span {
            pointer-events: none;
        }

        .back-button:hover {
            background: rgba(32, 178, 170, 1);
            transform: translateX(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }
        
        .back-button:active {
            transform: scale(0.95);
            background: rgba(26, 143, 138, 1);
        }
        
        /* Landing page */
        #landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        /* Grid background */
        .grid-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(#20B2AA 1px, transparent 1px),
                              linear-gradient(90deg, #20B2AA 1px, transparent 1px),
                              linear-gradient(#FFB6C1 1px, transparent 1px),
                              linear-gradient(90deg, #FFB6C1 1px, transparent 1px),
                              linear-gradient(rgba(32, 178, 170, 0.3) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(32, 178, 170, 0.3) 1px, transparent 1px);
            background-size: 20px 20px,
                             20px 20px,
                             100px 100px,
                             100px 100px, 
                             5px 5px,
                             5px 5px;
            z-index: -1;
        }
        
        /* Content box */
        .content-box {
            max-width: 500px;
            padding: 25px;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            z-index: 1;
        }
        
        .title {
            color: #FFB6C1;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 500;
            letter-spacing: 1px;
        }
        
        .description {
            color: #444;
            line-height: 1.5;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .start-button {
            padding: 12px 24px;
            background-color: #20B2AA;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            font-family: 'Roboto Mono', monospace;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            touch-action: manipulation;
        }
        
        .start-button:hover {
            background-color: #FFB6C1;
            transform: translateY(-2px);
        }
        
        .start-button:active {
            transform: scale(0.98);
        }
        
        .gesture-container {
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
        }
        
        .gesture-outline {
            width: 80px;
            height: 80px;
            border: 2px solid #FFB6C1;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0.8;
        }
        
        /* Wave icon for Evi */
        .gesture-icon {
            width: 50px;
            height: 50px;
            position: relative;
        }
        
        .gesture-icon::before,
        .gesture-icon::after {
            content: "";
            position: absolute;
        }
        
        .gesture-icon::before {
            width: 40px;
            height: 15px;
            top: 12px;
            left: 5px;
            border-radius: 50%;
            background: transparent;
            border-bottom: 3px solid #FFB6C1;
            transform: rotate(-5deg);
        }
        
        .gesture-icon::after {
            width: 40px;
            height: 10px;
            top: 24px;
            left: 5px;
            border-radius: 50%;
            background: transparent;
            border-bottom: 3px solid #20B2AA;
            transform: rotate(-2deg);
        }
        
        /* Loading indicator */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(240, 245, 250);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            font-family: 'Roboto Mono', monospace;
            color: #20B2AA;
        }
        
        /* Visualization container */
        #visualization-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: none;
        }
        
        /* Help message at the bottom */
        .help-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 182, 193, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            z-index: 200;
            text-align: center;
            pointer-events: none;
        }

        /* Mobile layout */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .back-button {
                padding: 10px 16px;
                font-size: 12px;
                top: 10px;
                left: 10px;
            }
            
            .grid-container {
                width: 100%;
                height: auto;
                min-height: 200px;
            }
            
            .visualization-container {
                width: 100%;
                height: 60vh;
            }
            
            .interaction-tips li {
                font-size: 12px;
            }
            
            .info {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Back button - OUTSIDE all containers, highest z-index -->
    <a id="back-button" href="../index.html" class="back-button">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        <span>Back</span>
    </a>
   
    <!-- Landing page -->
    <div id="landing-page">
        <div class="grid-background"></div>
        
        <div class="content-box">
            <div class="gesture-container">
                <div class="gesture-outline">
                    <div class="gesture-icon"></div>
                </div>
            </div>
            
            <h1 class="title">Evi: Emotional Pattern Analysis</h1>
            
            <p class="description">
                Observe Evi's emotional information processing system. This visualization demonstrates how Evi analyzes patterns through waves of emotional resonance, creating intuitive connections between emotional centers.
            </p>
            
            <p class="description">
                Through this interactive experience, you'll witness Evi's empathetic approach to gathering, recognizing, and synthesizing emotional information--prioritizing meaningful connections and insightful patterns.
            </p>
            
            <button id="start-button" class="start-button">BEGIN INTERACTION</button>
        </div>
    </div>
    
    <!-- Loading screen -->
    <div id="loading-screen">
        <h2>Loading...</h2>
        <p>Preparing visualization</p>
    </div>
    
    <!-- Visualization container -->
    <div id="visualization-container"></div>
    
    <script>
        // Global variables
        let p5Instance = null;
        
        // Helper function to check if element is the back button
        function isBackButton(element) {
            const backBtn = document.getElementById('back-button');
            return element === backBtn || (backBtn && backBtn.contains(element));
        }
        
        // Hand animation configuration
        const handAnimation = {
            frameCount: 6,
            currentFrame: 0,
            frameDuration: 100,
            opacity: 0.85,
            x: 0,
            y: 0,
            size: 250,
            frameImages: [],
            isPlaying: true,
            rotationOffset: 0,
            rotationSpeed: 0.001,
            lastFrameTime: 0
        };
        
        // Set up event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Start button event listeners
            document.getElementById('start-button').addEventListener('click', startExperience);
            document.getElementById('start-button').addEventListener('touchstart', function(e) {
                e.preventDefault();
                startExperience();
            });
            
            // Back button - ensure it works with both click and touch
            const backButton = document.getElementById('back-button');
            
            backButton.addEventListener('click', function(e) {
                console.log('Back button clicked');
                window.location.href = this.href;
            });
            
            backButton.addEventListener('touchend', function(e) {
                console.log('Back button touched');
                e.preventDefault();
                e.stopPropagation();
                window.location.href = this.href;
            }, { passive: false });
        });
        
        // Function to start the experience
        function startExperience() {
            console.log("Starting experience...");
            
            // Hide landing page completely
            document.getElementById('landing-page').style.display = 'none';
            
            // Show loading screen
            document.getElementById('loading-screen').style.display = 'flex';
            
            // Initialize the p5 sketch
            document.getElementById('visualization-container').style.display = 'block';
            
            try {
                console.log("Initializing p5 sketch...");
                new p5(eviSketch, 'visualization-container');
            } catch (error) {
                console.error("Error initializing p5:", error);
            }
            
            // Hide loading screen after a short delay
            setTimeout(function() {
                document.getElementById('loading-screen').style.display = 'none';
                console.log("Force hiding loading screen after timeout");
            }, 1500);
        }
        
        // Function to update hand animation frames
        function updateHandAnimation() {
            const anim = handAnimation;
            
            // Update rotation for gentle movement
            anim.rotationOffset += anim.rotationSpeed;
            
            // Advance to next frame based on timing
            setTimeout(() => {
                anim.currentFrame = (anim.currentFrame + 1) % anim.frameCount;
                
                // Continue animation
                requestAnimationFrame(updateHandAnimation);
            }, anim.frameDuration);
        }
        
        // Start animation loop
        updateHandAnimation();
        
        // Evi's visualization sketch
        const eviSketch = function(p) {
            // Store reference to the p5 instance
            p5Instance = p;
            
            // Visualization elements
            let waves = [];
            let emotionalCenters = [];
            let flowParticles = [];
            let moodColor;
            let intensityLevel = 0.5;
            let thoughtfulness = 0.5;
            
            // Sound elements
            let lastSoundTime = 0;
            
            // Color palettes
            const INTENSE_COLOR = [255, 182, 193];
            const CALM_COLOR = [32, 178, 170];
            const NEUTRAL_COLOR = [143, 188, 187];
            
            // Help messages
            let helpMessages = [
                "Tap anywhere to create an emotional center",
                "Drag to create a stream of emotional energy"
            ];
            let activeHelpMessageIndex = 0;
            
            p.preload = function() {
                console.log("Preloading assets...");
                
                setTimeout(() => {
                    console.log("Preload safety timeout triggered");
                }, 2000);
                
                // Create placeholder frames
                for (let i = 0; i < handAnimation.frameCount; i++) {
                    const placeholder = p.createGraphics(200, 200);
                    placeholder.background(255, 255, 255, 0);
                    placeholder.fill(255, 182, 193, 100);
                    placeholder.noStroke();
                    placeholder.ellipse(100, 100, 150, 150);
                    handAnimation.frameImages.push(placeholder);
                }
                
                // Try to load real frames
                for (let i = 1; i <= handAnimation.frameCount; i++) {
                    p.loadImage(
                        `evi-hand${i}.png`,
                        img => {
                            handAnimation.frameImages[i-1] = img;
                            console.log(`Loaded hand frame ${i}`);
                        },
                        err => {
                            console.log(`Failed to load hand frame ${i}, using placeholder`);
                        }
                    );
                }
                
                // Try to load sound
                try {
                    console.log("Loading sound...");
                    p.soundFormats('mp3', 'wav');
                    
                    p.interactionSound = p.loadSound(
                        'over-empathetic-sound.mp3',  
                        function() {
                            console.log("Sound loaded successfully!");
                        },
                        function(err) {
                            console.error("Sound loading error:", err);
                        }
                    );
                } catch (e) {
                    console.error('Sound loading exception:', e);
                    p.interactionSound = null;
                }
            };
            
            // Helper function to play sound
            function playSound() {
                try {
                    if (!lastSoundTime || Date.now() - lastSoundTime > 2000) {
                        p.userStartAudio().then(() => {
                            if (p.interactionSound && p.interactionSound.isLoaded() && !p.interactionSound.isPlaying()) {
                                p.interactionSound.setVolume(0.5);
                                p.interactionSound.play();
                                lastSoundTime = Date.now();
                                console.log("Sound played");
                            } else {
                                console.log("Sound not ready or already playing");
                            }
                        }).catch(e => {
                            console.log("Error starting audio:", e);
                        });
                    }
                } catch(e) {
                    console.log("Error playing sound:", e);
                }
            }
            
            // Draw hand animation frame
            function drawHandAnimationFrame() {
                try {
                    const anim = handAnimation;
                    
                    if (anim.frameImages.length > 0 && anim.frameImages[anim.currentFrame]) {
                        p.push();
                        
                        p.translate(anim.x, anim.y);
                        p.rotate(anim.rotationOffset);
                        p.translate(-anim.x, -anim.y);
                        
                        p.noStroke();
                        
                        for (let i = 0; i < 3; i++) {
                            const blurOpacity = anim.opacity * (100 - i * 20);
                            const blurSize = anim.size * (1.05 + i * 0.04);
                            p.fill(255, 255, 255, blurOpacity);
                            p.ellipse(anim.x, anim.y, blurSize);
                        }
                        
                        const img = anim.frameImages[anim.currentFrame];
                        
                        if (img) {
                            const aspectRatio = img.height / img.width || 1;
                            const drawHeight = anim.size * aspectRatio;
                            
                            p.tint(255, 255, 255, Math.min(255, anim.opacity * 255));
                            p.image(
                                img,
                                anim.x - anim.size/2,
                                anim.y - drawHeight/2,
                                anim.size,
                                drawHeight
                            );
                        }
                        
                        p.pop();
                    } else {
                        p.push();
                        p.noStroke();
                        p.fill(255, 182, 193, 100);
                        p.ellipse(anim.x, anim.y, 150);
                        p.pop();
                    }
                } catch(e) {
                    console.log("Error drawing animation frame:", e);
                    
                    p.push();
                    p.noStroke();
                    p.fill(255, 182, 193, 100);
                    p.ellipse(handAnimation.x, handAnimation.y, 150);
                    p.pop();
                }
            }
            
            p.setup = function() {
                console.log("p5 setup starting...");
                
                p.createCanvas(p.windowWidth, p.windowHeight);
                
                // Initialize waves
                for (let i = 0; i < 8; i++) {
                    waves.push({
                        baseHeight: p.height * (0.3 + i * 0.05),
                        amplitude: p.random(20, 50),
                        frequency: p.random(0.005, 0.02),
                        speed: p.random(0.01, 0.03),
                        phase: i * 0.5,
                        color: [...NEUTRAL_COLOR, 180],
                        thickness: p.random(1, 3)
                    });
                }
                
                moodColor = NEUTRAL_COLOR;
                
                // Create initial emotional centers
                for (let i = 0; i < 3; i++) {
                    emotionalCenters.push({
                        x: p.random(p.width * 0.2, p.width * 0.8),
                        y: p.random(p.height * 0.3, p.height * 0.7),
                        size: p.random(20, 60),
                        intensity: p.random(0.5, 1),
                        lifetime: 0,
                        maxLifetime: p.random(120, 240),
                        color: [...NEUTRAL_COLOR, 150]
                    });
                }
                
                handAnimation.x = p.width / 2;
                handAnimation.y = p.height / 2;
                
                createHelpMessages();
                
                try {
                    p.userStartAudio().catch(e => {
                        console.log("Audio will be initialized on user interaction");
                    });
                } catch(e) {
                    console.log("Audio initialization error:", e);
                }
                
                document.getElementById('loading-screen').style.display = 'none';
                
                console.log("p5 setup complete");
            };
            
            function createHelpMessages() {
                const existingMessages = document.querySelectorAll('.help-message');
                existingMessages.forEach(msg => msg.remove());
                
                helpMessages.forEach((text, index) => {
                    const msgElement = document.createElement('div');
                    msgElement.className = 'help-message';
                    msgElement.textContent = text;
                    msgElement.style.display = index === activeHelpMessageIndex ? 'block' : 'none';
                    document.body.appendChild(msgElement);
                });
            }
            
            function changeHelpMessage() {
                const messages = document.querySelectorAll('.help-message');
                if (messages.length > 0) {
                    messages.forEach((msg, index) => {
                        msg.style.display = index === activeHelpMessageIndex ? 'block' : 'none';
                    });
                    
                    activeHelpMessageIndex = (activeHelpMessageIndex + 1) % helpMessages.length;
                }
            }
            
            p.draw = function() {
                p.background(240, 245, 250, 20);
                
                intensityLevel = 0.5 + 0.4 * Math.sin(p.frameCount * 0.01);
                thoughtfulness = 0.5 + 0.4 * Math.sin(p.frameCount * 0.007 + 1);
                
                moodColor = [
                    p.lerp(CALM_COLOR[0], INTENSE_COLOR[0], intensityLevel),
                    p.lerp(CALM_COLOR[1], INTENSE_COLOR[1], intensityLevel),
                    p.lerp(CALM_COLOR[2], INTENSE_COLOR[2], intensityLevel)
                ];
                
                if (p.frameCount % 60 === 0 && p.random() < 0.3) {
                    emotionalCenters.push({
                        x: p.random(p.width * 0.2, p.width * 0.8),
                        y: p.random(p.height * 0.3, p.height * 0.7),
                        size: p.random(20, 60),
                        intensity: p.random(0.5, 1),
                        lifetime: 0,
                        maxLifetime: p.random(120, 240),
                        color: [...moodColor, 150]
                    });
                }
                
                // Draw waves
                for (let wave of waves) {
                    wave.phase += wave.speed * (0.5 + intensityLevel * 1.5);
                    wave.currentAmplitude = wave.amplitude * (0.8 + intensityLevel * 0.8);
                    wave.color = [...moodColor, 180 * (0.7 + 0.3 * (1 - thoughtfulness))];
                    wave.currentThickness = wave.thickness * (0.8 + 0.8 * (1 - thoughtfulness));
                    
                    p.stroke(wave.color);
                    p.strokeWeight(wave.currentThickness);
                    p.noFill();
                    p.beginShape();
                    for (let x = 0; x < p.width; x += 5) {
                        const y = wave.baseHeight + 
                                wave.currentAmplitude * Math.sin(x * wave.frequency + wave.phase) +
                                wave.currentAmplitude * 0.5 * Math.sin(x * wave.frequency * 2 + wave.phase * 1.5);
                        p.vertex(x, y);
                    }
                    p.endShape();
                }
                
                // Draw emotional centers
                for (let i = emotionalCenters.length - 1; i >= 0; i--) {
                    const center = emotionalCenters[i];
                    
                    center.lifetime++;
                    
                    const opacity = center.lifetime < center.maxLifetime * 0.2 
                        ? p.map(center.lifetime, 0, center.maxLifetime * 0.2, 0, 150)
                        : p.map(center.lifetime, center.maxLifetime * 0.2, center.maxLifetime, 150, 0);
                    
                    const pulseSize = center.size * (0.8 + 0.4 * Math.sin(center.lifetime * 0.05));
                    
                    for (let j = 3; j >= 0; j--) {
                        p.fill(center.color[0], center.color[1], center.color[2], opacity * (0.3 - j * 0.07));
                        p.noStroke();
                        p.ellipse(center.x, center.y, pulseSize * (1.2 + j * 0.2), pulseSize * (1.2 + j * 0.2));
                    }
                    
                    p.fill(center.color[0], center.color[1], center.color[2], opacity);
                    p.ellipse(center.x, center.y, pulseSize, pulseSize);
                    
                    if (center.lifetime >= center.maxLifetime) {
                        emotionalCenters.splice(i, 1);
                    }
                }
                
                // Draw connections
                if (emotionalCenters.length > 1) {
                    for (let i = 0; i < emotionalCenters.length; i++) {
                        for (let j = i + 1; j < emotionalCenters.length; j++) {
                            const c1 = emotionalCenters[i];
                            const c2 = emotionalCenters[j];
                            
                            const d = p.dist(c1.x, c1.y, c2.x, c2.y);
                            
                            if (d < p.width * 0.4) {
                                const strength = p.map(d, 0, p.width * 0.4, 0.8, 0);
                                
                                p.stroke(moodColor[0], moodColor[1], moodColor[2], 100 * strength);
                                p.strokeWeight(1 + 2 * strength);
                                
                                p.noFill();
                                p.beginShape();
                                const steps = 20;
                                for (let t = 0; t <= steps; t++) {
                                    const progress = t / steps;
                                    
                                    const x = p.lerp(c1.x, c2.x, progress);
                                    const displacement = Math.sin(progress * Math.PI) * 30 * 
                                                      Math.sin(p.frameCount * 0.05 + i * 0.5 + j * 0.5);
                                    const y = p.lerp(c1.y, c2.y, progress) + displacement;
                                    
                                    p.vertex(x, y);
                                }
                                p.endShape();
                                
                                if (p.frameCount % 10 === 0 && p.random() < 0.3 * intensityLevel) {
                                    flowParticles.push({
                                        startX: c1.x,
                                        startY: c1.y,
                                        endX: c2.x,
                                        endY: c2.y,
                                        progress: 0,
                                        speed: p.random(0.01, 0.03) * (0.5 + intensityLevel),
                                        size: p.random(3, 6),
                                        color: [...moodColor, 200]
                                    });
                                }
                            }
                        }
                    }
                }
                
                // Draw flow particles
                for (let i = flowParticles.length - 1; i >= 0; i--) {
                    const particle = flowParticles[i];
                    
                    particle.progress += particle.speed;
                    
                    const x = p.lerp(particle.startX, particle.endX, particle.progress);
                    const y = p.lerp(particle.startY, particle.endY, particle.progress);
                    
                    p.noStroke();
                    p.fill(particle.color);
                    p.ellipse(x, y, particle.size, particle.size);
                    
                    if (particle.progress >= 1) {
                        flowParticles.splice(i, 1);
                    }
                }
                
                drawHandAnimationFrame();
                
                if (p.frameCount % 300 === 0) {
                    changeHelpMessage();
                }
            };
            
            // Mouse/touch interaction - FIXED: check for back button
            p.mousePressed = function(event) {
                // Check if click is on back button
                if (event && event.target && isBackButton(event.target)) {
                    return true; // Allow default behavior
                }
                
                if (p.mouseX > 0 && p.mouseX < p.width && p.mouseY > 0 && p.mouseY < p.height) {
                    emotionalCenters.push({
                        x: p.mouseX,
                        y: p.mouseY,
                        size: p.random(30, 70),
                        intensity: 1.0,
                        lifetime: 0,
                        maxLifetime: p.random(180, 300),
                        color: [...INTENSE_COLOR, 180]
                    });
                    
                    playSound();
                    
                    return false;
                }
            };
            
            p.mouseDragged = function() {
                if (p.frameCount % 5 === 0) {
                    emotionalCenters.push({
                        x: p.mouseX,
                        y: p.mouseY,
                        size: p.random(15, 40),
                        intensity: 0.7,
                        lifetime: 0,
                        maxLifetime: p.random(60, 120),
                        color: [...moodColor, 150]
                    });
                }
                
                intensityLevel = Math.min(1, intensityLevel + 0.02);
                
                return false;
            };
            
            p.doubleClicked = function() {
                emotionalCenters = [];
                intensityLevel = 0.5;
                thoughtfulness = 0.5;
                return false;
            };
            
            p.windowResized = function() {
                p.resizeCanvas(p.windowWidth, p.windowHeight);
                
                for (let i = 0; i < waves.length; i++) {
                    waves[i].baseHeight = p.height * (0.3 + i * 0.05);
                }
                
                handAnimation.x = p.width / 2;
                handAnimation.y = p.height / 2;
            };
            
            // Touch support - FIXED: check for back button
            p.touchStarted = function(event) {
                // Check if touch is on back button
                if (event && event.target && isBackButton(event.target)) {
                    return true; // Allow default behavior
                }
                
                try {
                    if (p.touches.length > 0 && p.touches[0]) {
                        p.userStartAudio();
                        
                        const touchX = p.touches[0].x || p.touches[0].clientX || 0;
                        const touchY = p.touches[0].y || p.touches[0].clientY || 0;
                        
                        if (touchX > 0 && touchX < p.width && touchY > 0 && touchY < p.height) {
                            emotionalCenters.push({
                                x: touchX,
                                y: touchY,
                                size: p.random(30, 70),
                                intensity: 1.0,
                                lifetime: 0,
                                maxLifetime: p.random(180, 300),
                                color: [...INTENSE_COLOR, 180]
                            });
                            
                            playSound();
                        }
                    }
                } catch(e) {
                    console.log("Error in touchStarted:", e);
                }
                
                return false;
            };
            
            p.touchMoved = function(event) {
                // Check if touch is on back button
                if (event && event.target && isBackButton(event.target)) {
                    return true;
                }
                
                try {
                    if (p.touches.length > 0 && p.touches[0]) {
                        const touchX = p.touches[0].x || p.touches[0].clientX || 0;
                        const touchY = p.touches[0].y || p.touches[0].clientY || 0;
                        
                        if (p.frameCount % 5 === 0) {
                            emotionalCenters.push({
                                x: touchX,
                                y: touchY,
                                size: p.random(15, 40),
                                intensity: 0.7,
                                lifetime: 0,
                                maxLifetime: p.random(60, 120),
                                color: [...moodColor, 150]
                            });
                            
                            intensityLevel = Math.min(1, intensityLevel + 0.02);
                            
                            if (p.frameCount % 30 === 0) {
                                playSound();
                            }
                        }
                    }
                } catch(e) {
                    console.log("Error in touchMoved:", e);
                }
                
                return false;
            };
        };
        
        // Prevent default touch behaviors - FIXED: exclude back button
        document.addEventListener('touchmove', function(e) {
            if (document.getElementById('landing-page').style.display === 'none' && !isBackButton(e.target)) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchstart', function(e) {
            if (document.getElementById('landing-page').style.display === 'none' && 
                !e.target.closest('#start-button') && !isBackButton(e.target)) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>